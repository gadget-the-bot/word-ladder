<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WordLadder</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#121213;--surface:#1a1a1b;--border:#3a3a3c;--text:#fff;--text2:#818384;--green:#538d4e;--yellow:#b59f3b;--red:#c9402f;--blue:#4a90d9}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;display:flex;flex-direction:column;align-items:center}
header{width:100%;max-width:500px;padding:12px 16px;border-bottom:1px solid var(--border);text-align:center;position:relative}
header h1{font-size:28px;font-weight:800;letter-spacing:4px}
header .subtitle{font-size:12px;color:var(--text2);margin-top:2px}
.timer{font-size:11px;color:var(--text2);margin-top:4px}
main{width:100%;max-width:500px;padding:16px;flex:1;display:flex;flex-direction:column;gap:12px}
.word-box{display:flex;justify-content:center;gap:6px}
.word-box .letter{width:52px;height:52px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;border:2px solid var(--border);border-radius:4px;text-transform:uppercase;transition:all .3s}
.word-box.start .letter{border-color:var(--green);background:var(--green)}
.word-box.end .letter{border-color:var(--blue);background:var(--blue)}
.word-box.valid .letter{border-color:var(--green);background:var(--green);animation:pop .2s}
.word-box.invalid .letter{border-color:var(--red);background:var(--red);animation:shake .3s}
.word-box.current .letter{border-color:var(--yellow)}
@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.ladder{display:flex;flex-direction:column;gap:6px;align-items:center;flex:1;overflow-y:auto;padding:8px 0}
.connector{width:2px;height:16px;background:var(--border);margin:0 auto}
.input-row{display:flex;gap:8px;justify-content:center;align-items:center;padding:8px 0}
.input-row input{width:200px;height:48px;background:var(--surface);border:2px solid var(--border);border-radius:4px;color:var(--text);font-size:22px;font-weight:700;text-align:center;text-transform:uppercase;letter-spacing:8px;outline:none}
.input-row input:focus{border-color:var(--yellow)}
.input-row button{height:48px;padding:0 20px;background:var(--green);color:#fff;border:none;border-radius:4px;font-size:16px;font-weight:700;cursor:pointer}
.input-row button:active{opacity:.8}
.message{text-align:center;font-size:14px;min-height:20px;color:var(--red)}
.win-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:100;padding:16px}
.win-card{background:var(--surface);border-radius:12px;padding:32px 24px;text-align:center;max-width:400px;width:100%}
.win-card h2{font-size:28px;margin-bottom:8px}
.win-card .stats{display:flex;justify-content:center;gap:24px;margin:16px 0}
.win-card .stat{text-align:center}
.win-card .stat .num{font-size:32px;font-weight:700}
.win-card .stat .label{font-size:11px;color:var(--text2)}
.win-card .share-text{background:var(--bg);border-radius:8px;padding:12px;font-family:monospace;font-size:14px;margin:16px 0;white-space:pre;text-align:left;overflow-x:auto}
.win-card button{padding:12px 32px;background:var(--green);color:#fff;border:none;border-radius:4px;font-size:16px;font-weight:700;cursor:pointer;margin:4px}
.win-card .name-input{margin:12px 0}
.win-card .name-input input{width:200px;height:40px;background:var(--bg);border:2px solid var(--border);border-radius:4px;color:var(--text);font-size:16px;text-align:center;outline:none}
.leaderboard{margin-top:16px;text-align:left}
.leaderboard h3{text-align:center;margin-bottom:8px;font-size:16px;color:var(--text2)}
.leaderboard table{width:100%;border-collapse:collapse;font-size:13px}
.leaderboard td{padding:4px 8px;border-bottom:1px solid var(--border)}
.leaderboard td:first-child{width:30px;color:var(--text2)}
.leaderboard .you{color:var(--green);font-weight:700}
.tab-bar{display:flex;gap:0;margin-top:8px}
.tab-bar button{flex:1;padding:8px;background:var(--surface);border:1px solid var(--border);color:var(--text2);font-size:13px;cursor:pointer}
.tab-bar button.active{color:var(--text);border-bottom-color:var(--green)}
.hidden{display:none!important}
</style>
</head>
<body>
<header>
  <h1>WORDLADDER</h1>
  <div class="subtitle">Change one letter at a time</div>
  <div class="timer" id="timer"></div>
</header>
<main>
  <div class="ladder" id="ladder"></div>
  <div class="message" id="message"></div>
  <div class="input-row" id="inputRow">
    <input type="text" id="wordInput" maxlength="4" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="????">
    <button id="submitBtn">GO</button>
  </div>
  <div class="tab-bar">
    <button class="active" onclick="showTab('game')">Game</button>
    <button onclick="showTab('board')">Leaderboard</button>
  </div>
  <div id="boardPanel" class="leaderboard hidden"></div>
</main>
<div class="win-overlay hidden" id="winOverlay">
  <div class="win-card">
    <h2>ðŸŽ‰ You did it!</h2>
    <div class="stats">
      <div class="stat"><div class="num" id="winSteps">0</div><div class="label">STEPS</div></div>
      <div class="stat"><div class="num" id="winOptimal">0</div><div class="label">OPTIMAL</div></div>
      <div class="stat"><div class="num" id="winTime">0s</div><div class="label">TIME</div></div>
    </div>
    <div class="share-text" id="shareText"></div>
    <button onclick="copyShare()">ðŸ“‹ Copy Results</button>
    <div class="name-input">
      <input type="text" id="nameInput" placeholder="Your name" maxlength="20">
      <button onclick="submitScore()">Submit Score</button>
    </div>
    <div id="submitMsg" style="font-size:13px;color:var(--green);margin-top:8px"></div>
    <button onclick="document.getElementById('winOverlay').classList.add('hidden')" style="background:var(--border);margin-top:8px">Close</button>
  </div>
</div>
<script>
let puzzle=null,chain=[],startTime=0,won=false;
const $=id=>document.getElementById(id);
const API=window.location.origin;

async function init(){
  try{
    const r=await fetch(API+'/api/puzzle');
    puzzle=await r.json();
  }catch(e){
    $('message').textContent='Failed to load puzzle. Try refreshing.';
    return;
  }
  chain=[puzzle.start];
  startTime=Date.now();
  won=false;
  render();
  updateTimer();
  setInterval(updateTimer,1000);
  $('wordInput').focus();
}

function render(){
  const ladder=$('ladder');
  ladder.innerHTML='';
  // Start word
  ladder.appendChild(makeWordBox(puzzle.start,'start'));
  // Chain (excluding start)
  for(let i=1;i<chain.length;i++){
    ladder.appendChild(makeConnector());
    ladder.appendChild(makeWordBox(chain[i],'valid'));
  }
  if(!won){
    ladder.appendChild(makeConnector());
    // Show target
    const remaining=document.createElement('div');
    remaining.style.cssText='color:var(--text2);font-size:12px;text-align:center;padding:4px';
    remaining.textContent='â¬‡';
    ladder.appendChild(remaining);
    ladder.appendChild(makeConnector());
    ladder.appendChild(makeWordBox(puzzle.end,'end'));
  }
  ladder.scrollTop=ladder.scrollHeight;
}

function makeWordBox(word,cls){
  const div=document.createElement('div');
  div.className='word-box '+(cls||'');
  for(const ch of word){
    const span=document.createElement('div');
    span.className='letter';
    span.textContent=ch;
    div.appendChild(span);
  }
  return div;
}

function makeConnector(){
  const d=document.createElement('div');
  d.className='connector';
  return d;
}

async function tryWord(){
  if(won)return;
  const input=$('wordInput');
  const word=input.value.trim().toUpperCase();
  if(word.length!==4){$('message').textContent='Enter a 4-letter word';return;}
  
  const prev=chain[chain.length-1];
  
  // Check if it's the end word
  if(word===puzzle.end.toUpperCase()){
    // Validate it's one letter off
    const r=await fetch(API+'/api/validate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({word,previousWord:prev})});
    const d=await r.json();
    if(d.valid){
      chain.push(word);
      won=true;
      render();
      showWin();
      input.value='';
      return;
    }
  }
  
  try{
    const r=await fetch(API+'/api/validate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({word,previousWord:prev})});
    const d=await r.json();
    if(d.valid){
      chain.push(word);
      $('message').textContent='';
      input.value='';
      // Check if we reached the end
      if(word===puzzle.end.toUpperCase()){
        won=true;
        render();
        showWin();
        return;
      }
      render();
    }else{
      if(!d.isWord)$('message').textContent='Not a valid word';
      else if(!d.isOneOff)$('message').textContent='Must change exactly one letter';
      // Flash red
      const ladder=document.querySelector('.ladder');
      const temp=makeWordBox(word,'invalid');
      ladder.insertBefore(makeConnector(),ladder.children[ladder.children.length-3]);
      ladder.insertBefore(temp,ladder.children[ladder.children.length-3]);
      setTimeout(()=>{temp.remove();ladder.querySelector('.connector:nth-last-child(4)')?.remove()},600);
    }
  }catch(e){$('message').textContent='Network error';}
  input.value='';
  input.focus();
}

function showWin(){
  const steps=chain.length-1;
  const elapsed=Math.round((Date.now()-startTime)/1000);
  $('winSteps').textContent=steps;
  $('winOptimal').textContent=puzzle.optimalSteps;
  $('winTime').textContent=elapsed<60?elapsed+'s':Math.floor(elapsed/60)+'m '+elapsed%60+'s';
  
  // Build share text
  const rating=steps<=puzzle.optimalSteps?'ðŸŸ¢':steps<=puzzle.optimalSteps+1?'ðŸŸ¡':'ðŸ”´';
  let share=`ðŸªœ WordLadder ${puzzle.date}\n`;
  share+=`${chain[0]} â†’ ${chain[chain.length-1]}\n`;
  share+=`${steps} steps (optimal: ${puzzle.optimalSteps}) ${rating}\n`;
  for(let i=0;i<chain.length;i++){
    if(i===0)share+='ðŸŸ©';
    else if(i===chain.length-1)share+='ðŸŸ¦';
    else share+='â¬œ';
  }
  $('shareText').textContent=share;
  $('winOverlay').classList.remove('hidden');
  
  // Restore name
  const saved=localStorage.getItem('wl_name');
  if(saved)$('nameInput').value=saved;
}

function copyShare(){
  navigator.clipboard.writeText($('shareText').textContent).then(()=>{
    $('message').textContent='Copied!';
    setTimeout(()=>$('message').textContent='',2000);
  });
}

async function submitScore(){
  const name=$('nameInput').value.trim();
  if(!name){$('submitMsg').textContent='Enter a name first';return;}
  localStorage.setItem('wl_name',name);
  const steps=chain.length-1;
  const time=Math.round((Date.now()-startTime)/1000);
  try{
    const r=await fetch(API+'/api/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,steps,time})});
    const d=await r.json();
    $('submitMsg').textContent=d.success?`Submitted! Rank #${d.rank}`:'Error submitting';
  }catch(e){$('submitMsg').textContent='Network error';}
}

function updateTimer(){
  const now=new Date();
  const utcMidnight=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate()+1));
  const diff=utcMidnight-now;
  const h=Math.floor(diff/3600000);
  const m=Math.floor((diff%3600000)/60000);
  const s=Math.floor((diff%60000)/1000);
  $('timer').textContent=`Next puzzle in ${h}h ${m}m ${s}s`;
}

function showTab(tab){
  document.querySelectorAll('.tab-bar button').forEach((b,i)=>{b.classList.toggle('active',i===(tab==='game'?0:1))});
  $('boardPanel').classList.toggle('hidden',tab==='game');
  $('ladder').classList.toggle('hidden',tab!=='game');
  $('inputRow').classList.toggle('hidden',tab!=='game');
  if(tab==='board')loadLeaderboard();
}

async function loadLeaderboard(){
  try{
    const r=await fetch(API+'/api/leaderboard');
    const d=await r.json();
    let html='<h3>Today\'s Leaderboard</h3>';
    if(!d.entries.length){html+='<p style="text-align:center;color:var(--text2)">No scores yet today</p>';}
    else{
      html+='<table>';
      d.entries.forEach((e,i)=>{
        html+=`<tr><td>#${i+1}</td><td>${e.name}</td><td>${e.steps} steps</td><td>${e.time}s</td></tr>`;
      });
      html+='</table>';
    }
    $('boardPanel').innerHTML=html;
  }catch(e){$('boardPanel').innerHTML='<p style="text-align:center;color:var(--text2)">Failed to load</p>';}
}

$('submitBtn').addEventListener('click',tryWord);
$('wordInput').addEventListener('keydown',e=>{if(e.key==='Enter')tryWord()});
init();
</script>
</body>
</html>
